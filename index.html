<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JMVN - Generador Pro V2.1</title>
    <style>
        :root { --accent: #ff0055; --bg: #111; --text: #eee; --panel: #222; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; touch-action: none; }
        
        header { text-align: center; margin-bottom: 20px; width: 100%; position: relative; }
        h1 { margin: 0; font-size: 2.2rem; letter-spacing: 2px; text-transform: uppercase; }
        .red-text { color: var(--accent); } .white-text { color: white; }

        /* Bot√≥n de Galer√≠a en Header */
        .header-btn { position: absolute; right: 20px; top: 10px; background: #333; border: 1px solid #555; padding: 8px 15px; border-radius: 5px; color: white; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .header-btn:hover { background: #444; border-color: var(--accent); }

        .container { background: var(--panel); padding: 25px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); width: 95%; max-width: 1400px; display: grid; grid-template-columns: 320px 1fr; gap: 25px; }
        
        /* Controles */
        .controls { display: flex; flex-direction: column; gap: 12px; height: fit-content; max-height: 90vh; overflow-y: auto; }
        .control-group { background: #333; padding: 12px; border-radius: 10px; border: 1px solid #444; }
        .control-group.project-meta { border-color: var(--accent); background: #2a1a1f; }
        
        label { display: block; font-size: 0.85rem; color: #aaa; margin-bottom: 6px; }
        input[type="text"], input[type="file"], input[type="number"], select { width: 100%; padding: 8px; background: #222; border: 1px solid #555; color: white; border-radius: 4px; box-sizing: border-box; }
        input[type="range"] { width: 100%; cursor: pointer; }
        
        button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; font-size: 0.9rem; }
        button:hover { filter: brightness(1.2); }
        button:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }
        button.edit-mode-btn { background: #2196F3; box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3); }

        .val { float: right; color: var(--accent); font-weight: bold; }
        .dimensions-display { text-align: center; color: #00E676; font-family: monospace; font-size: 1.1rem; margin-top: 10px; }

        /* √Årea de SVG / Canvas */
        #visualWrapper { background: #fff; border-radius: 8px; height: 650px; position: relative; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; }
        #svgContent { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        
        /* --- MODO EDICI√ìN (OVERLAY) --- */
        #editorOverlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: #1a1a1a; z-index: 100; display: none; flex-direction: column; 
        }
        #editorCanvas { flex-grow: 1; cursor: grab; background: #e0e0e0; touch-action: none; }
        #editorCanvas:active { cursor: grabbing; }

        .editor-toolbar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); pointer-events: auto;
        }
        .tool-btn {
            width: 45px; height: 45px; border-radius: 50%; border: 2px solid transparent;
            background: #333; color: white; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .tool-btn.active { border-color: white; transform: scale(1.1); }
        .tool-btn.delete.active { background: var(--accent); }
        .tool-btn.add.active { background: #00E676; color: black; }
        .tool-btn.move.active { background: #2196F3; }

        .editor-actions {
            position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; gap: 20px; pointer-events: none;
        }
        .editor-actions button { pointer-events: auto; width: 140px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .btn-confirm { background: #00C853; }
        .btn-discard { background: #D50000; }

        /* --- MODALES (Galer√≠a y Exportar) --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #222; padding: 25px; border-radius: 12px; width: 90%; max-width: 600px;
            border: 1px solid #444; max-height: 85vh; overflow-y: auto; text-align: center;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; width: auto; padding: 0; color: #888; }
        
        /* Lista de Proyectos */
        .project-list { list-style: none; padding: 0; margin: 0; text-align: left; }
        .project-item { 
            background: #333; margin-bottom: 10px; padding: 15px; border-radius: 8px; 
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #333;
        }
        .project-item:hover { border-color: var(--accent); }
        .p-info h4 { margin: 0 0 5px 0; color: white; }
        .p-info span { font-size: 0.8rem; color: #aaa; }
        .btn-load { width: auto; padding: 8px 20px; font-size: 0.8rem; background: #2196F3; }

        /* Opciones de Exportaci√≥n */
        .export-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 20px; }
        .export-option { background: #333; padding: 20px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .export-option:hover { border-color: var(--accent); background: #2a1a1f; }
        .export-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
        .export-label { font-weight: bold; color: white; display: block; }
        .export-desc { font-size: 0.75rem; color: #aaa; margin-top: 5px; display: block; }

        /* Controles de Flechas para MOVER */
        #dpad {
            position: absolute; bottom: 90px; right: 20px; width: 120px; height: 120px;
            display: none; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr 1fr;
            pointer-events: auto; opacity: 0.8;
        }
        .d-btn { background: #444; border: 1px solid #666; color: white; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .d-btn:active { background: #2196F3; }
        
        .footer { margin-top: 30px; text-align: center; color: #555; font-size: 0.9rem; border-top: 1px solid #333; padding-top: 20px; width: 100%; }
        .gemini-tag { color: var(--accent); font-weight: bold; font-size: 0.8rem; letter-spacing: 1px; display: block; margin-top: 5px; }

        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } #visualWrapper { height: 500px; } .header-btn { position: relative; right: auto; top: auto; display: inline-flex; margin-bottom: 15px; } }
    </style>
</head>
<body>

    <header>
        <h1><span class="red-text">HERRAMIENTAS INTELIGENTES</span> <span class="white-text">JMVN</span></h1>
        <button class="header-btn" onclick="openGallery()">üìÇ Ver Dise√±os Guardados</button>
    </header>

    <div class="container">
        <div class="controls">
            <div class="control-group project-meta">
                <label style="color:white; font-weight:bold;">NOMBRE DEL PROYECTO *</label>
                <input type="text" id="projectName" placeholder="Ej: Logo Camisa 01" autocomplete="off">
            </div>

            <div class="control-group" id="imgInputGroup">
                <label>1. Imagen del Logo (Nuevo)</label>
                <input type="file" id="imageInput" accept="image/*">
            </div>

            <div class="control-group">
                <label>2. Configuraci√≥n F√≠sica</label>
                <label style="font-size:0.75rem">Ancho Real de Impresi√≥n (cm):</label>
                <input type="number" id="realWidthCm" value="25" step="0.5">
            </div>

            <div class="control-group">
                <label>3. Distribuci√≥n (Solo Nuevos)</label>
                <select id="mode" class="param-input">
                    <option value="adaptive">Trazo Adaptativo (Curvas)</option>
                    <option value="honeycomb">Panal Org√°nico</option>
                    <option value="grid">Ladrillo Recto</option>
                </select>
            </div>

            <div class="control-group">
                <label>Separaci√≥n Vertical: <span id="yStepVal" class="val">--</span> mm</label>
                <input type="range" id="yStep" class="param-input" min="2" max="40" value="8">
            </div>

            <div class="control-group">
                <label>Densidad Horizontal: <span id="xStepVal" class="val">--</span> mm</label>
                <input type="range" id="xStep" class="param-input" min="2" max="40" value="8">
            </div>

            <div class="control-group">
                <label>√Ångulo: <span id="angleVal" class="val">0</span>¬∞</label>
                <input type="range" id="angle" class="param-input" min="-45" max="45" value="0">
            </div>

            <div class="control-group">
                <label>Tama√±o Piedra (aprox): <span id="radiusVal" class="val">--</span> mm</label>
                <input type="range" id="radius" class="param-input" min="1" max="20" step="0.5" value="2.5">
            </div>

            <button onclick="processImage()" id="btnGenerate">Generar Trama Base</button>
            <button class="edit-mode-btn" id="btnOpenEditor" onclick="openEditor()" disabled>üõ†Ô∏è Entrar a Modo Edici√≥n</button>
            <div class="dimensions-display" id="dimDisplay">0 cm x 0 cm</div>
        </div>

        <div id="visualWrapper">
            <div id="svgContent">
                <div style="color:#bbb; text-align:center">Sube imagen o carga proyecto<br>para visualizar.</div>
            </div>

            <div id="editorOverlay">
                <div class="editor-toolbar">
                    <button class="tool-btn delete active" onclick="setTool('delete')" title="Eliminar (Rojo)">üóëÔ∏è</button>
                    <button class="tool-btn add" onclick="setTool('add')" title="Agregar (Verde)">‚ûï</button>
                    <button class="tool-btn move" onclick="setTool('move')" title="Mover (Azul)">‚úã</button>
                </div>

                <canvas id="editorCanvas"></canvas>
                
                <div id="dpad">
                    <div></div><button class="d-btn" onclick="nudge(0,-1)">‚ñ≤</button><div></div>
                    <button class="d-btn" onclick="nudge(-1,0)">‚óÄ</button>
                    <button class="d-btn" style="background:#2196F3; border:none;">‚óè</button>
                    <button class="d-btn" onclick="nudge(1,0)">‚ñ∂</button>
                    <div></div><button class="d-btn" onclick="nudge(0,1)">‚ñº</button><div></div>
                </div>

                <div class="editor-actions">
                    <button class="btn-discard" onclick="discardChanges()">Descartar ‚ùå</button>
                    <button class="btn-confirm" onclick="confirmChanges()">CONFIRMAR ‚úÖ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="galleryModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0">Dise√±os Guardados</h3>
                <button class="close-btn" onclick="closeGallery()">√ó</button>
            </div>
            <div id="galleryList" class="project-list">
                <div style="padding:20px; color:#aaa;">Cargando proyectos...</div>
            </div>
        </div>
    </div>

    <div id="exportModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0">Seleccionar Formato</h3>
                <button class="close-btn" onclick="closeExport()">√ó</button>
            </div>
            <p>El dise√±o se guardar√° en la nube y se descargar√° en:</p>
            <div class="export-grid">
                <div class="export-option" onclick="finalizeExport('svg')">
                    <span class="export-icon">üé®</span>
                    <span class="export-label">SVG</span>
                    <span class="export-desc">Web, Illustrator, Corel</span>
                </div>
                <div class="export-option" onclick="finalizeExport('plt')">
                    <span class="export-icon">üì†</span>
                    <span class="export-label">PLT (HPGL)</span>
                    <span class="export-desc">Plotters, L√°ser, Corte</span>
                </div>
                <div class="export-option" onclick="finalizeExport('ai')">
                    <span class="export-icon">‚úíÔ∏è</span>
                    <span class="export-label">AI (EPS)</span>
                    <span class="export-desc">Adobe Illustrator Legacy</span>
                </div>
            </div>
        </div>
    </div>

    <canvas id="procCanvas" style="display:none;"></canvas>

    <div class="footer">
        Desarrollado por <strong>JES√öS VALLEJO</strong><br>
        <span class="gemini-tag">POWERED BY GEMINI 3 PRO - V2.1 (FIXED)</span>
        <div style="margin-top:10px; font-style:italic; font-size:0.75rem">
            HERRAMIENTA DE USO EXCLUSIVO PARA EMPLEADOS DE <b>VIVA ROUSS</b> Y <b>MISS ROUSS</b>.
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCngQL1pdqghv2vbjkPycT1Xf0C46f7jYs",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- FUNCIONES DE BASE DE DATOS ---

        window.fetchProjectsFromDB = async () => {
            const list = document.getElementById('galleryList');
            list.innerHTML = '<div style="padding:20px; color:#aaa;">Cargando...</div>';
            
            try {
                const q = query(collection(db, "proyectos_pedreria"), orderBy("fecha", "desc"), limit(20));
                const querySnapshot = await getDocs(q);
                
                list.innerHTML = "";
                if(querySnapshot.empty) {
                    list.innerHTML = '<div style="padding:20px;">No hay proyectos guardados a√∫n.</div>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.fecha ? data.fecha.toDate().toLocaleDateString() : "S/F";
                    const safeName = data.nombre_proyecto || "Sin nombre";
                    
                    const li = document.createElement('div');
                    li.className = 'project-item';
                    li.innerHTML = `
                        <div class="p-info">
                            <h4>${safeName}</h4>
                            <span>${date} ‚Ä¢ ${data.puntos_total || "?"} puntos</span>
                        </div>
                        <button class="btn-load" onclick='loadProjectData(${JSON.stringify(data).replace(/'/g, "&#39;")})'>CARGAR</button>
                    `;
                    list.appendChild(li);
                });
            } catch (e) {
                console.error(e);
                list.innerHTML = '<div style="color:red">Error cargando lista.</div>';
            }
        };

        window.saveToFirebase = async (points, svgString, format) => {
            const name = document.getElementById('projectName').value.trim();
            if(!name) return; 
            
            try {
                const pointsJson = JSON.stringify(points);

                await addDoc(collection(db, "proyectos_pedreria"), {
                    nombre_proyecto: name,
                    puntos_total: points.length,
                    puntos_json: pointsJson, 
                    svg_generado: svgString, // Guardamos tambi√©n el SVG para backup
                    formato_exportado: format,
                    config: window.getLastConfig(),
                    fecha: serverTimestamp(),
                    autor: "JES√öS VALLEJO / STAFF"
                });
                console.log("‚úÖ Guardado en Firebase con JSON de puntos.");
            } catch(e) {
                console.error("Error guardando:", e);
                alert("‚ö†Ô∏è Se descarg√≥ el archivo, pero hubo un error guardando en la base de datos.");
            }
        };
    </script>

    <script>
        // --- ESTADO GLOBAL ---
        let globalPoints = [];     
        let backupPoints = [];     
        let canvasWidth = 1000;       
        let canvasHeight = 1000;
        let isLoadedProject = false; 
        
        let manualEditsMade = false;

        // --- ESTADO DEL EDITOR ---
        let editTool = 'delete';
        let selectedPointIdx = -1;
        let editorScale = 1;
        let editorOffsetX = 0;
        let editorOffsetY = 0;
        let isDragging = false;
        let lastMouse = {x:0, y:0};
        
        // --- INPUTS UI ---
        const inputs = document.querySelectorAll('.param-input');
        inputs.forEach(i => i.addEventListener('input', handleParamChange));
        
        document.getElementById('realWidthCm').addEventListener('input', updateLabels);
        document.getElementById('radius').addEventListener('input', () => {
            if(isLoadedProject) renderSVGPreview(); 
            updateLabels();
        });

        inputs.forEach(i => i.addEventListener('mousedown', checkManualEditsWarning));
        inputs.forEach(i => i.addEventListener('touchstart', checkManualEditsWarning));

        function checkManualEditsWarning() {
            if(manualEditsMade && !isLoadedProject) {
                const proceed = confirm("‚ö†Ô∏è ¬°ADVERTENCIA!\n\nHiciste ediciones manuales. Si cambias la densidad/√°ngulo, se regenerar√° todo y PERDER√ÅS tus ediciones.\n\n¬øContinuar?");
                if(proceed) {
                    manualEditsMade = false;
                    processImage(); 
                }
            }
        }

        function handleParamChange(e) {
            updateLabels();
            if(isLoadedProject && (e.target.id === 'yStep' || e.target.id === 'xStep' || e.target.id === 'angle')) {
                return;
            }
        }

        function updateLabels() {
            const realW = parseFloat(document.getElementById('realWidthCm').value) || 25;
            const w = canvasWidth > 0 ? canvasWidth : 1000;
            const scaleFactor = (realW * 10) / w; 
            
            document.getElementById('yStepVal').innerText = (document.getElementById('yStep').value * scaleFactor).toFixed(1);
            document.getElementById('xStepVal').innerText = (document.getElementById('xStep').value * scaleFactor).toFixed(1);
            document.getElementById('angleVal').innerText = document.getElementById('angle').value;
            
            const rPx = parseFloat(document.getElementById('radius').value);
            document.getElementById('radiusVal').innerText = (rPx * 2 * scaleFactor).toFixed(1);

            if(canvasHeight > 0) {
                const hCm = (canvasHeight * (realW / w)).toFixed(1);
                document.getElementById('dimDisplay').innerText = `Dimensiones Finales: ${realW} cm x ${hCm} cm`;
            }
        }

        window.getLastConfig = () => {
            return {
                mode: document.getElementById('mode').value,
                realWidth: document.getElementById('realWidthCm').value,
                radiusPx: document.getElementById('radius').value,
                generatedDate: new Date().toISOString()
            };
        }

        // --- GALER√çA Y CARGA ---
        function openGallery() {
            document.getElementById('galleryModal').style.display = 'flex';
            if(window.fetchProjectsFromDB) window.fetchProjectsFromDB();
        }
        function closeGallery() { document.getElementById('galleryModal').style.display = 'none'; }

        // --- CARGA DE PROYECTO (VERSION MEJORADA V2.1) ---
        window.loadProjectData = (data) => {
            if(confirm("Al cargar un proyecto se borrar√° el trabajo actual. ¬øContinuar?")) {
                try {
                    globalPoints = [];

                    // CASO 1: PROYECTO NUEVO (Tiene JSON de puntos)
                    if (data.puntos_json) {
                        globalPoints = JSON.parse(data.puntos_json);
                        console.log("Carga: Modo JSON nativo");
                    } 
                    // CASO 2: PROYECTO ANTIGUO (Solo tiene SVG) - INTENTO DE RESCATE
                    else if (data.svg_generado) {
                        console.log("Carga: Modo rescate SVG");
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(data.svg_generado, "image/svg+xml");
                        const circles = doc.querySelectorAll('circle');
                        
                        if(circles.length > 0) {
                            circles.forEach(c => {
                                globalPoints.push({
                                    x: parseFloat(c.getAttribute('cx')),
                                    y: parseFloat(c.getAttribute('cy'))
                                });
                            });
                            alert("‚ö†Ô∏è ESTE PROYECTO ERA ANTIGUO.\n\nEl sistema ha reconstruido los puntos desde el dibujo visual. Ahora podr√°s editar el tama√±o de piedra y guardar en los nuevos formatos.");
                        } else {
                            alert("‚ùå Error: El archivo antiguo est√° vac√≠o o da√±ado.");
                            return;
                        }
                    } else {
                        alert("‚ùå Error: Este proyecto no tiene datos v√°lidos.");
                        return;
                    }

                    // Restaurar Configuraci√≥n B√°sica
                    document.getElementById('projectName').value = data.nombre_proyecto;
                    if(data.config) {
                        document.getElementById('realWidthCm').value = data.config.realWidth || 25;
                        document.getElementById('radius').value = data.config.radiusPx || 2.5;
                    }

                    // Ajustar entorno
                    isLoadedProject = true;
                    manualEditsMade = false; 
                    
                    // Recalcular tama√±o del lienzo basado en los puntos
                    let maxX = 0, maxY = 0;
                    globalPoints.forEach(p => {
                        if(p.x > maxX) maxX = p.x;
                        if(p.y > maxY) maxY = p.y;
                    });
                    canvasWidth = maxX + 50; 
                    canvasHeight = maxY + 50;
                    
                    // UI Updates
                    document.getElementById('btnOpenEditor').disabled = false;
                    document.getElementById('imgInputGroup').style.display = 'none'; 
                    document.getElementById('btnGenerate').style.display = 'none'; 
                    closeGallery();
                    
                    renderSVGPreview();
                    updateLabels();

                } catch(e) {
                    console.error(e);
                    alert("Error procesando datos del proyecto.");
                }
            }
        };

        // --- PROCESAMIENTO DE IMAGEN (NUEVO) ---
        function processImage() {
            const input = document.getElementById('imageInput');
            if (!input.files[0]) return alert("Selecciona una imagen primero.");

            manualEditsMade = false; 
            isLoadedProject = false;
            document.getElementById('btnGenerate').style.display = 'block';

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const c = document.getElementById('procCanvas');
                    const ctx = c.getContext('2d', { willReadFrequently: true });
                    
                    const maxW = 1000;
                    const scale = maxW / img.width;
                    c.width = maxW;
                    c.height = img.height * scale;
                    
                    canvasWidth = c.width;
                    canvasHeight = c.height;

                    ctx.fillStyle = "white";
                    ctx.fillRect(0,0,c.width, c.height);
                    ctx.drawImage(img, 0, 0, c.width, c.height);
                    
                    generatePoints(ctx);
                    renderSVGPreview();
                    updateLabels();
                    document.getElementById('btnOpenEditor').disabled = false;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }

        function generatePoints(ctx) {
            const yStep = parseInt(document.getElementById('yStep').value);
            const xStep = parseInt(document.getElementById('xStep').value);
            const angle = parseInt(document.getElementById('angle').value) * (Math.PI / 180);
            const mode = document.getElementById('mode').value;
            
            const w = ctx.canvas.width;
            const h = ctx.canvas.height;
            const imgData = ctx.getImageData(0, 0, w, h);
            
            globalPoints = [];

            for (let y = -h; y < h * 2; y += yStep) {
                let segment = [];
                for (let x = -w; x < w * 2; x += 1) {
                    const rotX = Math.floor(x * Math.cos(angle) - y * Math.sin(angle));
                    const rotY = Math.floor(x * Math.sin(angle) + y * Math.cos(angle));

                    if (rotX >= 0 && rotX < w && rotY >= 0 && rotY < h) {
                        const idx = (rotY * w + rotX) * 4;
                        if (imgData.data[idx] < 150) {
                            segment.push({x: rotX, y: rotY});
                        } else if (segment.length > 0) {
                            addSegment(segment, xStep, mode);
                            segment = [];
                        }
                    }
                }
                if (segment.length > 0) addSegment(segment, xStep, mode);
            }
        }

        function addSegment(seg, step, mode) {
            if (seg.length < 2) return;
            if (mode === 'adaptive') {
                const count = Math.max(1, Math.round(seg.length / step));
                for(let i=0; i<count; i++) {
                    const idx = Math.floor((seg.length / (count+1)) * (i+1));
                    globalPoints.push(seg[idx]);
                }
            } else {
                for(let i=0; i<seg.length; i+=step) globalPoints.push(seg[i]);
            }
        }

        function renderSVGPreview() {
            const r = parseFloat(document.getElementById('radius').value);
            let svg = `<svg viewBox="0 0 ${canvasWidth} ${canvasHeight}" style="max-height:100%; max-width:100%;"><g fill="black">`;
            globalPoints.forEach(p => {
                svg += `<circle cx="${p.x.toFixed(1)}" cy="${p.y.toFixed(1)}" r="${r}" />`;
            });
            svg += `</g></svg>`;
            document.getElementById('svgContent').innerHTML = svg;
        }

        // --- MODO EDICI√ìN (CANVAS) ---
        const editorCanvas = document.getElementById('editorCanvas');
        const ctxEdit = editorCanvas.getContext('2d');
        let initialPinchDist = 0;

        function openEditor() {
            backupPoints = JSON.parse(JSON.stringify(globalPoints)); 
            document.getElementById('editorOverlay').style.display = 'flex';
            
            const rect = document.getElementById('visualWrapper').getBoundingClientRect();
            editorCanvas.width = rect.width;
            editorCanvas.height = rect.height;
            
            editorScale = Math.min(editorCanvas.width / canvasWidth, editorCanvas.height / canvasHeight) * 0.9;
            editorOffsetX = (editorCanvas.width - canvasWidth * editorScale) / 2;
            editorOffsetY = (editorCanvas.height - canvasHeight * editorScale) / 2;

            requestAnimationFrame(drawEditorLoop);
        }

        function setTool(t) {
            editTool = t;
            selectedPointIdx = -1; 
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.tool-btn.${t}`).classList.add('active');
            document.getElementById('dpad').style.display = (t === 'move') ? 'grid' : 'none';
            drawEditorLoop();
        }

        function drawEditorLoop() {
            ctxEdit.clearRect(0, 0, editorCanvas.width, editorCanvas.height);
            ctxEdit.save();
            ctxEdit.translate(editorOffsetX, editorOffsetY);
            ctxEdit.scale(editorScale, editorScale);
            
            ctxEdit.fillStyle = "white";
            ctxEdit.fillRect(0,0, canvasWidth, canvasHeight);
            
            const r = parseFloat(document.getElementById('radius').value);

            for(let i=0; i<globalPoints.length; i++) {
                const p = globalPoints[i];
                ctxEdit.beginPath();
                ctxEdit.arc(p.x, p.y, r, 0, Math.PI*2);
                
                if (editTool === 'delete') {
                    ctxEdit.fillStyle = "black"; ctxEdit.fill();
                    ctxEdit.lineWidth = r/2; ctxEdit.strokeStyle = "red"; ctxEdit.stroke();
                } 
                else if (editTool === 'move' && i === selectedPointIdx) {
                    ctxEdit.fillStyle = "#2196F3"; ctxEdit.fill();
                    ctxEdit.strokeStyle = "#2196F3"; ctxEdit.lineWidth = 2;
                    ctxEdit.beginPath(); ctxEdit.arc(p.x, p.y, r * 2, 0, Math.PI*2); ctxEdit.stroke();
                }
                else {
                    ctxEdit.fillStyle = "black"; ctxEdit.fill();
                }
            }
            ctxEdit.restore();
        }

        // Helpers de interacci√≥n
        function screenToWorld(sx, sy) {
            return { x: (sx - editorOffsetX) / editorScale, y: (sy - editorOffsetY) / editorScale };
        }

        editorCanvas.addEventListener('mousedown', startPan);
        editorCanvas.addEventListener('mousemove', movePan);
        editorCanvas.addEventListener('mouseup', endPan);
        editorCanvas.addEventListener('wheel', handleWheel);
        
        editorCanvas.addEventListener('touchstart', (e) => {
            if(e.touches.length === 2) {
                isDragging = false; 
                initialPinchDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            } else startPan(e.touches[0]);
        });
        editorCanvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if(e.touches.length === 2) {
                const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                const zoomFactor = (dist - initialPinchDist) * 0.005;
                editorScale *= (1 + zoomFactor);
                initialPinchDist = dist;
                drawEditorLoop();
            } else movePan(e.touches[0]);
        });
        editorCanvas.addEventListener('touchend', (e) => { if(e.touches.length === 0) endPan(e.changedTouches[0]); });

        let startClickTime = 0;
        let didMove = false;

        function startPan(e) {
            isDragging = true; didMove = false; startClickTime = Date.now();
            const rect = editorCanvas.getBoundingClientRect();
            lastMouse = { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }

        function movePan(e) {
            if (!isDragging) return;
            const rect = editorCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left; const y = e.clientY - rect.top;
            if (Math.abs(x - lastMouse.x) > 2 || Math.abs(y - lastMouse.y) > 2) didMove = true;
            editorOffsetX += (x - lastMouse.x); editorOffsetY += (y - lastMouse.y);
            lastMouse = {x, y};
            drawEditorLoop();
        }

        function endPan(e) {
            isDragging = false;
            const timeDiff = Date.now() - startClickTime;
            if (timeDiff < 300 && !didMove) {
                const rect = editorCanvas.getBoundingClientRect();
                const clickX = (e.clientX || e.pageX) - rect.left;
                const clickY = (e.clientY || e.pageY) - rect.top;
                handleToolClick(clickX, clickY);
            }
        }

        function handleWheel(e) {
            e.preventDefault();
            const s = (e.deltaY < 0) ? 1.1 : 0.9;
            const rect = editorCanvas.getBoundingClientRect();
            const mx = e.clientX - rect.left; const my = e.clientY - rect.top;
            editorOffsetX = mx - (mx - editorOffsetX) * s;
            editorOffsetY = my - (my - editorOffsetY) * s;
            editorScale *= s;
            drawEditorLoop();
        }

        function handleToolClick(sx, sy) {
            const wPos = screenToWorld(sx, sy);
            const r = parseFloat(document.getElementById('radius').value);
            let hitIdx = -1; let minDist = r * 2.5;

            for(let i=0; i<globalPoints.length; i++) {
                const d = Math.hypot(globalPoints[i].x - wPos.x, globalPoints[i].y - wPos.y);
                if (d < minDist) { minDist = d; hitIdx = i; }
            }

            if (editTool === 'delete' && hitIdx !== -1) {
                globalPoints.splice(hitIdx, 1); manualEditsMade = true;
            } else if (editTool === 'add' && hitIdx === -1) {
                globalPoints.push({x: wPos.x, y: wPos.y}); manualEditsMade = true;
            } else if (editTool === 'move') {
                if (hitIdx !== -1) selectedPointIdx = hitIdx;
                else if (selectedPointIdx !== -1) {
                    globalPoints[selectedPointIdx].x = wPos.x;
                    globalPoints[selectedPointIdx].y = wPos.y;
                    manualEditsMade = true;
                }
            }
            drawEditorLoop();
        }

        window.nudge = (dx, dy) => {
            if (selectedPointIdx !== -1) {
                globalPoints[selectedPointIdx].x += dx; globalPoints[selectedPointIdx].y += dy;
                manualEditsMade = true; drawEditorLoop();
            }
        };

        window.discardChanges = () => {
            if(confirm("¬øDescartar cambios y volver al inicio de edici√≥n?")) {
                globalPoints = backupPoints;
                document.getElementById('editorOverlay').style.display = 'none';
                manualEditsMade = false;
                renderSVGPreview();
            }
        };

        // --- EXPORTACI√ìN Y CONFIRMACI√ìN ---

        window.confirmChanges = () => {
            const name = document.getElementById('projectName').value.trim();
            if(!name) { alert("Por favor ingresa un NOMBRE DEL PROYECTO antes de confirmar."); return; }
            
            document.getElementById('editorOverlay').style.display = 'none';
            renderSVGPreview();
            
            document.getElementById('exportModal').style.display = 'flex';
        };

        function closeExport() { document.getElementById('exportModal').style.display = 'none'; }

        window.finalizeExport = async (format) => {
            const name = document.getElementById('projectName').value.trim() || "dise√±o";
            const svgString = document.getElementById('svgContent').innerHTML;
            
            let blob = null;
            let extension = "";

            if (format === 'svg') {
                blob = new Blob([svgString], {type: "image/svg+xml"});
                extension = ".svg";
            } 
            else if (format === 'plt') {
                const pltContent = generatePLT();
                blob = new Blob([pltContent], {type: "text/plain"});
                extension = ".plt";
            }
            else if (format === 'ai') {
                const aiContent = generateEPS();
                blob = new Blob([aiContent], {type: "application/postscript"});
                extension = ".ai"; 
            }

            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = name + "_JMVN" + extension;
            a.click();

            if (window.saveToFirebase) {
                await window.saveToFirebase(globalPoints, svgString, format);
            }
            
            closeExport();
            alert(`‚úÖ Archivo ${extension} descargado y proyecto guardado.`);
        };

        // GENERADOR PLT (HPGL)
        function generatePLT() {
            const realW_mm = parseFloat(document.getElementById('realWidthCm').value) * 10;
            const pxToMm = realW_mm / canvasWidth;
            const mmToPlt = 40; 
            const scale = pxToMm * mmToPlt;
            
            const rPx = parseFloat(document.getElementById('radius').value);
            const rPlt = (rPx * scale).toFixed(0);

            let plt = "IN;PU;"; 
            
            globalPoints.forEach(p => {
                const x = (p.x * scale).toFixed(0);
                const y = (-p.y * scale).toFixed(0); 
                plt += `PU${x},${y};CI${rPlt};`; 
            });
            
            plt += "PU0,0;IN;";
            return plt;
        }

        // GENERADOR EPS (Compatible con Illustrator)
        function generateEPS() {
            const realW_pt = parseFloat(document.getElementById('realWidthCm').value) * 28.3465; // cm a postscript points
            const scale = realW_pt / canvasWidth;
            const h_pt = canvasHeight * scale;
            const r = parseFloat(document.getElementById('radius').value) * scale;

            let eps = `%!PS-Adobe-3.0 EPSF-3.0
%%BoundingBox: 0 0 ${realW_pt.toFixed(2)} ${h_pt.toFixed(2)}
%%Creator: JMVN Tool
%%Title: Pedreria Export
%%EndComments
`;
            eps += `/c { 0 360 arc fill } def\n0 setgray\n`; 

            globalPoints.forEach(p => {
                const x = (p.x * scale).toFixed(2);
                const y = (h_pt - (p.y * scale)).toFixed(2); 
                eps += `${x} ${y} ${r.toFixed(2)} c\n`;
            });
            
            eps += `%%EOF`;
            return eps;
        }

    </script>
</body>
</html>
