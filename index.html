<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JMVN - Generador Pro V3.2 (Modular)</title>
    <style>
        :root { --accent: #ff0055; --bg: #111; --text: #eee; --panel: #222; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; touch-action: none; }
        
        header { text-align: center; margin-bottom: 20px; width: 100%; position: relative; }
        h1 { margin: 0; font-size: 2.2rem; letter-spacing: 2px; text-transform: uppercase; }
        .red-text { color: var(--accent); } .white-text { color: white; }

        /* Botonera Header */
        .header-controls { position: absolute; right: 20px; top: 10px; display: flex; gap: 10px; }
        .header-btn { background: #333; border: 1px solid #555; padding: 8px 15px; border-radius: 5px; color: white; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        .header-btn:hover { background: #444; border-color: var(--accent); }

        .container { background: var(--panel); padding: 25px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.8); width: 95%; max-width: 1400px; display: grid; grid-template-columns: 320px 1fr; gap: 25px; }
        
        /* Controles */
        .controls { display: flex; flex-direction: column; gap: 12px; height: fit-content; max-height: 90vh; overflow-y: auto; }
        .control-group { background: #333; padding: 12px; border-radius: 10px; border: 1px solid #444; }
        .control-group.project-meta { border-color: var(--accent); background: #2a1a1f; }
        
        label { display: block; font-size: 0.85rem; color: #aaa; margin-bottom: 6px; }
        input[type="text"], input[type="file"], input[type="number"], select, textarea { width: 100%; padding: 8px; background: #222; border: 1px solid #555; color: white; border-radius: 4px; box-sizing: border-box; }
        input[type="range"] { width: 100%; cursor: pointer; }
        
        button { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; font-size: 0.9rem; transition: 0.2s; }
        button:hover { filter: brightness(1.2); }
        button:disabled { background: #555; cursor: not-allowed; opacity: 0.7; }
        button.edit-mode-btn { background: #2196F3; box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3); }
        button.text-tool-btn { background: #9C27B0; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(156, 39, 176, 0.3); }

        .val { float: right; color: var(--accent); font-weight: bold; }
        .dimensions-display { text-align: center; color: #00E676; font-family: monospace; font-size: 1.1rem; margin-top: 10px; }

        /* √Årea de SVG / Canvas */
        #visualWrapper { background: #fff; border-radius: 8px; height: 650px; position: relative; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; }
        #svgContent { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        
        /* --- MODO EDICI√ìN (OVERLAY) --- */
        #editorOverlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: #1a1a1a; z-index: 100; display: none; flex-direction: column; 
        }
        #editorCanvas { flex-grow: 1; cursor: grab; background: #e0e0e0; touch-action: none; }
        #editorCanvas:active { cursor: grabbing; }

        .editor-toolbar {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); pointer-events: auto;
        }
        .tool-btn {
            width: 45px; height: 45px; border-radius: 50%; border: 2px solid transparent;
            background: #333; color: white; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .tool-btn.active { border-color: white; transform: scale(1.1); }
        .tool-btn.delete.active { background: var(--accent); }
        .tool-btn.add.active { background: #00E676; color: black; }
        .tool-btn.move.active { background: #2196F3; }

        .editor-actions {
            position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: center; gap: 20px; pointer-events: none;
        }
        .editor-actions button { pointer-events: auto; width: 140px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .btn-confirm { background: #00C853; }
        .btn-discard { background: #D50000; }

        /* --- MODALES GENERALES --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200; display: none;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #222; padding: 25px; border-radius: 12px; width: 90%; max-width: 850px; 
            border: 1px solid #444; max-height: 90vh; overflow-y: auto; text-align: center; position: relative;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; width: auto; padding: 0; color: #888; }
        
        /* Lista de Proyectos */
        .project-list { list-style: none; padding: 0; margin: 0; text-align: left; }
        .project-item { 
            background: #333; margin-bottom: 10px; padding: 15px; border-radius: 8px; 
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #333;
        }
        .project-item:hover { border-color: var(--accent); }
        .p-info h4 { margin: 0 0 5px 0; color: white; }
        .p-info span { font-size: 0.8rem; color: #aaa; }
        .btn-load { width: auto; padding: 8px 20px; font-size: 0.8rem; background: #2196F3; }

        /* Opciones de Exportaci√≥n */
        .export-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 20px; }
        .export-option { background: #333; padding: 20px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .export-option:hover { border-color: var(--accent); background: #2a1a1f; }
        .export-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
        .export-label { font-weight: bold; color: white; display: block; }

        /* --- ESTILOS MODAL TEXTO (MODULAR) --- */
        .text-preview-area { 
            background: #fff; height: 160px; display: flex; align-items: center; justify-content: center; 
            border-radius: 8px; margin-bottom: 15px; overflow: hidden; 
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%); 
            background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; 
        }

        .text-inputs-row {
            display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 15px;
            background: #333; padding: 15px; border-radius: 10px; margin-bottom: 20px;
            text-align: left; align-items: center;
        }

        .effects-container { text-align: left; }
        .effects-label { font-size: 1.1rem; color: var(--accent); font-weight: bold; margin-bottom: 10px; display: block; }
        
        /* IFRAME CONTAINER PARA EFECTOS */
        #effectsFrame {
            width: 100%;
            height: 380px;
            border: 2px solid #444;
            border-radius: 8px;
            background: #111;
        }

        .font-item { display: flex; justify-content: space-between; background: #333; padding: 10px; margin-bottom: 5px; border-radius: 5px; align-items: center; }

        /* Controles de Flechas para MOVER */
        #dpad {
            position: absolute; bottom: 90px; right: 20px; width: 120px; height: 120px;
            display: none; grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr 1fr;
            pointer-events: auto; opacity: 0.8;
        }
        .d-btn { background: #444; border: 1px solid #666; color: white; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .d-btn:active { background: #2196F3; }
        
        .footer { margin-top: 30px; text-align: center; color: #555; font-size: 0.9rem; border-top: 1px solid #333; padding-top: 20px; width: 100%; }
        .gemini-tag { color: var(--accent); font-weight: bold; font-size: 0.8rem; letter-spacing: 1px; display: block; margin-top: 5px; }

        @media (max-width: 900px) { 
            .container { grid-template-columns: 1fr; } 
            #visualWrapper { height: 500px; } 
            .header-controls { position: relative; right: auto; top: auto; display: flex; margin-bottom: 15px; justify-content: center; } 
            .text-inputs-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <header>
        <h1><span class="red-text">HERRAMIENTAS INTELIGENTES</span> <span class="white-text">JMVN</span></h1>
        <div class="header-controls">
            <button class="header-btn" onclick="openFontManager()">üÖ∞Ô∏è Gesti√≥n Fuentes</button>
            <button class="header-btn" onclick="openGallery()">üìÇ Ver Dise√±os</button>
        </div>
    </header>

    <div class="container">
        <div class="controls">
            <button class="text-tool-btn" onclick="openTextTool()">‚ú® CREAR TEXTO M√ÅGICO ‚ú®</button>

            <div class="control-group project-meta">
                <label style="color:white; font-weight:bold;">NOMBRE DEL PROYECTO *</label>
                <input type="text" id="projectName" placeholder="Ej: Logo Versace 01" autocomplete="off">
            </div>

            <div class="control-group" id="imgInputGroup">
                <label>1. O Cargar Imagen (Si no usas texto)</label>
                <input type="file" id="imageInput" accept="image/*">
            </div>

            <div class="control-group">
                <label>2. Configuraci√≥n F√≠sica</label>
                <label style="font-size:0.75rem">Ancho Real de Impresi√≥n (cm):</label>
                <input type="number" id="realWidthCm" value="25" step="0.5">
            </div>

            <div class="control-group">
                <label>3. Distribuci√≥n</label>
                <select id="mode" class="param-input">
                    <option value="adaptive">Trazo Adaptativo (Curvas)</option>
                    <option value="honeycomb">Panal Org√°nico</option>
                    <option value="grid">Ladrillo Recto</option>
                </select>
            </div>

            <div class="control-group">
                <label>Separaci√≥n Vertical: <span id="yStepVal" class="val">--</span> mm</label>
                <input type="range" id="yStep" class="param-input" min="2" max="40" value="8">
            </div>

            <div class="control-group">
                <label>Densidad Horizontal: <span id="xStepVal" class="val">--</span> mm</label>
                <input type="range" id="xStep" class="param-input" min="2" max="40" value="8">
            </div>

            <div class="control-group">
                <label>√Ångulo: <span id="angleVal" class="val">0</span>¬∞</label>
                <input type="range" id="angle" class="param-input" min="-45" max="45" value="0">
            </div>

            <div class="control-group">
                <label>Tama√±o Piedra (aprox): <span id="radiusVal" class="val">--</span> mm</label>
                <input type="range" id="radius" class="param-input" min="1" max="20" step="0.5" value="2.5">
            </div>

            <button onclick="processImage()" id="btnGenerate">Generar Trama Base</button>
            <button class="edit-mode-btn" id="btnOpenEditor" onclick="openEditor()" disabled>üõ†Ô∏è Entrar a Modo Edici√≥n</button>
            <div class="dimensions-display" id="dimDisplay">0 cm x 0 cm</div>
        </div>

        <div id="visualWrapper">
            <div id="svgContent">
                <div style="color:#bbb; text-align:center">Usa "Crear Texto M√°gico" o sube imagen<br>para comenzar.</div>
            </div>

            <div id="editorOverlay">
                <div class="editor-toolbar">
                    <button class="tool-btn delete active" onclick="setTool('delete')" title="Eliminar (Rojo)">üóëÔ∏è</button>
                    <button class="tool-btn add" onclick="setTool('add')" title="Agregar (Verde)">‚ûï</button>
                    <button class="tool-btn move" onclick="setTool('move')" title="Mover (Azul)">‚úã</button>
                </div>

                <canvas id="editorCanvas"></canvas>
                
                <div id="dpad">
                    <div></div><button class="d-btn" onclick="nudge(0,-1)">‚ñ≤</button><div></div>
                    <button class="d-btn" onclick="nudge(-1,0)">‚óÄ</button>
                    <button class="d-btn" style="background:#2196F3; border:none;">‚óè</button>
                    <button class="d-btn" onclick="nudge(1,0)">‚ñ∂</button>
                    <div></div><button class="d-btn" onclick="nudge(0,1)">‚ñº</button><div></div>
                </div>

                <div class="editor-actions">
                    <button class="btn-discard" onclick="discardChanges()">Descartar ‚ùå</button>
                    <button class="btn-confirm" onclick="confirmChanges()">CONFIRMAR ‚úÖ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="galleryModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0">Dise√±os Guardados</h3>
                <button class="close-btn" onclick="closeModal('galleryModal')">√ó</button>
            </div>
            <div id="galleryList" class="project-list"></div>
        </div>
    </div>

    <div id="fontManagerModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0">Gestor de Fuentes</h3>
                <button class="close-btn" onclick="closeModal('fontManagerModal')">√ó</button>
            </div>
            <div style="text-align:left; margin-bottom:20px; background:#333; padding:15px; border-radius:8px;">
                <label>Nombre de la Fuente</label>
                <input type="text" id="newFontName" placeholder="Ej: Versace Font">
                <label style="margin-top:10px;">URL del archivo (.ttf, .otf o Google Font URL)</label>
                <input type="text" id="newFontUrl" placeholder="https://...">
                <button onclick="saveNewFont()" style="margin-top:10px; background:#00E676; color:black;">+ Agregar a Base de Datos</button>
            </div>
            <h4 style="text-align:left">Fuentes Disponibles:</h4>
            <div id="fontListDisplay" class="project-list" style="max-height:200px; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="textToolModal" class="modal-backdrop">
        <div class="modal-content" style="max-width:900px;">
            <div class="modal-header">
                <h3 style="margin:0">‚ú® Dise√±ador de Texto M√°gico</h3>
                <button class="close-btn" onclick="closeModal('textToolModal')">√ó</button>
            </div>
            
            <div class="text-preview-area">
                <canvas id="textPreviewCanvas" height="160"></canvas>
            </div>

            <div class="text-inputs-row">
                <div>
                    <label>Texto:</label>
                    <textarea id="txtString" rows="1" style="resize:none; font-size:1.1rem; letter-spacing:1px;" oninput="updateTextPreview()">VERSACE</textarea>
                </div>
                <div>
                    <label>Fuente:</label>
                    <select id="txtFontFamily" onchange="updateTextPreview()">
                        <option value="Arial">Arial (Sistema)</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Impact">Impact</option>
                        <option value="Courier New">Courier New</option>
                        </select>
                </div>
                <div>
                    <label>Tama√±o / Dispersi√≥n:</label>
                    <input type="range" id="rngTxtSize" min="40" max="300" value="120" oninput="updateTextPreview()" title="Tama√±o Texto">
                    <input type="range" id="rngScatter" min="10" max="100" value="40" oninput="updateTextPreview()" style="margin-top:5px;" title="Intensidad Efecto">
                </div>
            </div>

            <div class="effects-container">
                <span class="effects-label">üìö Cat√°logo de Efectos (Cargado desde M√≥dulo Externo)</span>
                
                <iframe id="effectsFrame" src="efectos.html"></iframe>
                
            </div>

            <button onclick="applyTextToWorkspace()" style="margin-top:20px; font-size:1.1rem; width:100%;">üöÄ GENERAR PEDRER√çA Y CERRAR</button>
        </div>
    </div>

    <div id="exportModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0">Seleccionar Formato</h3>
                <button class="close-btn" onclick="closeModal('exportModal')">√ó</button>
            </div>
            <p>El dise√±o se guardar√° en la nube y se descargar√° en:</p>
            <div class="export-grid">
                <div class="export-option" onclick="finalizeExport('svg')">
                    <span class="export-icon">üé®</span>
                    <span class="export-label">SVG</span>
                </div>
                <div class="export-option" onclick="finalizeExport('plt')">
                    <span class="export-icon">üì†</span>
                    <span class="export-label">PLT (HPGL)</span>
                </div>
                <div class="export-option" onclick="finalizeExport('ai')">
                    <span class="export-icon">‚úíÔ∏è</span>
                    <span class="export-label">AI (EPS)</span>
                </div>
            </div>
        </div>
    </div>

    <canvas id="procCanvas" style="display:none;"></canvas>

    <div class="footer">
        Desarrollado por <strong>JES√öS VALLEJO</strong><br>
        <span class="gemini-tag">POWERED BY GEMINI 3 PRO - V3.2 (MODULAR SYSTEM)</span>
        <div style="margin-top:10px; font-style:italic; font-size:0.75rem">
            HERRAMIENTA DE USO EXCLUSIVO PARA EMPLEADOS DE <b>VIVA ROUSS</b> Y <b>MISS ROUSS</b>.
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCngQL1pdqghv2vbjkPycT1Xf0C46f7jYs",
            authDomain: "cirineo-cec21.firebaseapp.com",
            projectId: "cirineo-cec21",
            storageBucket: "cirineo-cec21.firebasestorage.app",
            messagingSenderId: "620210618284",
            appId: "1:620210618284:web:482bab9bf74650fff18409"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- GESTI√ìN DE PROYECTOS ---
        window.fetchProjectsFromDB = async () => {
            const list = document.getElementById('galleryList');
            list.innerHTML = '<div style="padding:20px; color:#aaa;">Cargando...</div>';
            try {
                const q = query(collection(db, "proyectos_pedreria"), orderBy("fecha", "desc"), limit(20));
                const querySnapshot = await getDocs(q);
                list.innerHTML = "";
                if(querySnapshot.empty) {
                    list.innerHTML = '<div style="padding:20px;">No hay proyectos.</div>';
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.fecha ? data.fecha.toDate().toLocaleDateString() : "S/F";
                    const safeName = data.nombre_proyecto || "Sin nombre";
                    const li = document.createElement('div');
                    li.className = 'project-item';
                    li.innerHTML = `
                        <div class="p-info"><h4>${safeName}</h4><span>${date} ‚Ä¢ ${data.puntos_total || "?"} pts</span></div>
                        <button class="btn-load" onclick='loadProjectData(${JSON.stringify(data).replace(/'/g, "&#39;")})'>CARGAR</button>
                    `;
                    list.appendChild(li);
                });
            } catch (e) { console.error(e); list.innerHTML = '<div style="color:red">Error cargando lista.</div>'; }
        };

        window.saveToFirebase = async (points, svgString, format) => {
            const name = document.getElementById('projectName').value.trim();
            if(!name) return; 
            try {
                await addDoc(collection(db, "proyectos_pedreria"), {
                    nombre_proyecto: name,
                    puntos_total: points.length,
                    puntos_json: JSON.stringify(points), 
                    svg_generado: svgString,
                    formato_exportado: format,
                    config: window.getLastConfig(),
                    fecha: serverTimestamp(),
                    autor: "JES√öS VALLEJO"
                });
            } catch(e) { console.error("Error DB:", e); }
        };

        // --- GESTI√ìN DE FUENTES ---
        window.fetchFontsFromDB = async () => {
            const list = document.getElementById('fontListDisplay');
            const select = document.getElementById('txtFontFamily');
            list.innerHTML = "Cargando...";
            
            try {
                const q = query(collection(db, "fuentes_usuario"), orderBy("nombre", "asc"));
                const querySnapshot = await getDocs(q);
                
                list.innerHTML = "";
                while (select.options.length > 4) { select.remove(4); }

                querySnapshot.forEach((doc) => {
                    const f = doc.data();
                    const item = document.createElement('div');
                    item.className = 'font-item';
                    item.innerHTML = `<strong>${f.nombre}</strong><span style="font-size:0.7rem; color:#aaa; max-width:150px; overflow:hidden; text-overflow:ellipsis;">${f.url}</span>`;
                    list.appendChild(item);
                    loadFontToBrowser(f.nombre, f.url);
                    const opt = document.createElement('option');
                    opt.value = f.nombre;
                    opt.text = f.nombre + " (Custom)";
                    select.add(opt);
                });
            } catch (e) { console.error(e); list.innerHTML = "Error cargando fuentes."; }
        };

        window.saveNewFont = async () => {
            const name = document.getElementById('newFontName').value.trim();
            const url = document.getElementById('newFontUrl').value.trim();
            if(!name || !url) return alert("Llena ambos campos");
            try {
                await addDoc(collection(db, "fuentes_usuario"), { nombre: name, url: url, fecha: serverTimestamp() });
                alert("Fuente agregada. Se recargar√° la lista.");
                document.getElementById('newFontName').value = "";
                document.getElementById('newFontUrl').value = "";
                window.fetchFontsFromDB();
            } catch(e) { alert("Error guardando fuente."); }
        };

        async function loadFontToBrowser(name, url) {
            try {
                const font = new FontFace(name, `url(${url})`);
                await font.load();
                document.fonts.add(font);
            } catch(e) { console.error("No se pudo cargar la fuente visualmente:", name); }
        }
        
        window.fetchFontsFromDB();
    </script>

    <script>
        // --- ESTADO GLOBAL ---
        let globalPoints = [];     
        let backupPoints = [];     
        let canvasWidth = 1000;       
        let canvasHeight = 1000;
        let isLoadedProject = false; 
        let manualEditsMade = false;

        // Estado del Editor de Texto (Por defecto 'fill' hasta que el iframe diga lo contrario)
        let currentTextEffect = 'fill';
        
        // --- UI HELPERS ---
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openGallery() { document.getElementById('galleryModal').style.display = 'flex'; if(window.fetchProjectsFromDB) window.fetchProjectsFromDB(); }
        function openFontManager() { document.getElementById('fontManagerModal').style.display = 'flex'; if(window.fetchFontsFromDB) window.fetchFontsFromDB(); }
        
        // --- L√ìGICA DEL DISE√ëADOR DE TEXTO & COMUNICACI√ìN CON EFECTOS.HTML ---
        
        // 1. Escuchar mensajes del iframe (efectos.html)
        window.addEventListener('message', (event) => {
            // Verificar origen si fuera necesario, aqu√≠ asumimos local/mismo dominio
            if (event.data && event.data.action === 'applyEffect') {
                const effectName = event.data.effectName;
                console.log("Efecto recibido desde m√≥dulo externo:", effectName);
                
                // Actualizar estado local
                currentTextEffect = effectName;
                
                // Habilitar o deshabilitar sliders seg√∫n el efecto (l√≥gica de UI)
                const sc = document.getElementById('rngScatter');
                // Si el efecto es simple, desactivamos scatter
                const simpleEffects = ['fill', 'outline'];
                sc.disabled = simpleEffects.includes(effectName);
                sc.parentElement.style.opacity = sc.disabled ? '0.5' : '1';

                // Actualizar la vista previa inmediatamente
                updateTextPreview();
            }
        });

        function openTextTool() {
            document.getElementById('textToolModal').style.display = 'flex';
            updateTextPreview();
        }

        // NOTA: La funci√≥n selectEffect() ha sido eliminada de aqu√≠ porque ahora
        // la selecci√≥n sucede dentro del iframe 'efectos.html'.

        function updateTextPreview() {
            const cvs = document.getElementById('textPreviewCanvas');
            const ctx = cvs.getContext('2d');
            const text = document.getElementById('txtString').value;
            const fontName = document.getElementById('txtFontFamily').value;
            const size = parseInt(document.getElementById('rngTxtSize').value);
            const scatter = parseInt(document.getElementById('rngScatter').value);

            // Ajustar canvas din√°micamente
            cvs.width = Math.max(600, text.length * (size * 0.6) + 100);
            cvs.height = size * 2.5;

            // Fondo negro (representa la camiseta)
            ctx.fillStyle = "black";
            ctx.fillRect(0,0,cvs.width, cvs.height);

            ctx.font = `bold ${size}px "${fontName}"`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            const cx = cvs.width / 2;
            const cy = cvs.height / 2;

            // L√≥gica de Renderizado (Motor Gr√°fico)
            if (currentTextEffect === 'fill') {
                ctx.fillStyle = "white";
                ctx.fillText(text, cx, cy);
            } 
            else if (currentTextEffect === 'outline') {
                ctx.strokeStyle = "white";
                ctx.lineWidth = size * 0.05;
                ctx.strokeText(text, cx, cy);
            }
            else if (currentTextEffect === 'versace_box') {
                const metrics = ctx.measureText(text);
                const w = metrics.width + size;
                const h = size * 1.5;
                drawScatterRect(ctx, cx - w/2, cy - h/2, w, h, scatter, true);
                ctx.globalCompositeOperation = 'destination-out';
                ctx.fillText(text, cx, cy);
                ctx.globalCompositeOperation = 'source-over';
            }
            else if (currentTextEffect === 'versace_text') {
                const tempCvs = document.createElement('canvas');
                tempCvs.width = cvs.width; tempCvs.height = cvs.height;
                const tCtx = tempCvs.getContext('2d');
                tCtx.font = ctx.font; tCtx.textAlign = ctx.textAlign; tCtx.textBaseline = ctx.textBaseline;
                tCtx.fillStyle = "white";
                tCtx.fillText(text, cx, cy);
                drawScatterText(ctx, tCtx, scatter);
            }
        }

        function drawScatterRect(ctx, x, y, w, h, intensity, invert) {
            for(let i=0; i<3000; i++) {
                const px = x + Math.random() * w;
                const py = y + Math.random() * h;
                const dx = Math.abs(px - (x + w/2)) / (w/2);
                const prob = 1 - (dx * (intensity/50)); 
                if(Math.random() < 1) { 
                    ctx.fillStyle = "rgba(255,255,255,0.8)";
                    ctx.beginPath(); ctx.arc(px, py, 1, 0, Math.PI*2); ctx.fill();
                }
            }
            ctx.fillStyle = "rgba(255,255,255,0.1)"; 
            ctx.fillRect(x + w*0.1, y + h*0.1, w*0.8, h*0.8);
        }

        function drawScatterText(targetCtx, sourceCtx, intensity) {
            targetCtx.drawImage(sourceCtx.canvas, 0, 0);
        }

        // --- APLICAR TEXTO AL WORKSPACE PRINCIPAL ---
        function applyTextToWorkspace() {
            const previewCvs = document.getElementById('textPreviewCanvas');
            const procCanvas = document.getElementById('procCanvas');
            const ctx = procCanvas.getContext('2d');
            
            procCanvas.width = previewCvs.width * 2;
            procCanvas.height = previewCvs.height * 2;
            
            const text = document.getElementById('txtString').value;
            const fontName = document.getElementById('txtFontFamily').value;
            const size = parseInt(document.getElementById('rngTxtSize').value) * 2;
            const scatter = parseInt(document.getElementById('rngScatter').value);

            ctx.fillStyle = "white"; 
            ctx.fillRect(0,0, procCanvas.width, procCanvas.height);
            
            ctx.font = `bold ${size}px "${fontName}"`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            const cx = procCanvas.width / 2;
            const cy = procCanvas.height / 2;
            
            ctx.fillStyle = "black";
            ctx.strokeStyle = "black";

            if (currentTextEffect === 'fill') {
                ctx.fillText(text, cx, cy);
            }
            else if (currentTextEffect === 'outline') {
                ctx.lineWidth = size * 0.05;
                ctx.strokeText(text, cx, cy);
            }
            else if (currentTextEffect === 'versace_box') {
                const metrics = ctx.measureText(text);
                const w = metrics.width + size;
                const h = size * 1.5;
                highQualityScatterBox(ctx, cx, cy, w, h, scatter);
                ctx.globalCompositeOperation = 'destination-out';
                ctx.fillText(text, cx, cy);
                ctx.globalCompositeOperation = 'source-over';
            }
            else if (currentTextEffect === 'versace_text') {
                ctx.fillText(text, cx, cy);
                applyEdgeScatter(ctx, scatter);
            }

            canvasWidth = procCanvas.width;
            canvasHeight = procCanvas.height;
            document.getElementById('textToolModal').style.display = 'none';
            document.getElementById('imgInputGroup').style.display = 'none';
            document.getElementById('btnGenerate').style.display = 'block';
            
            generatePoints(ctx);
            renderSVGPreview();
            updateLabels();
            document.getElementById('btnOpenEditor').disabled = false;
        }

        function highQualityScatterBox(ctx, cx, cy, w, h, intensity) {
            const steps = 15000 * (intensity/10); 
            for(let i=0; i<steps; i++) {
                let rx = (Math.random() - 0.5) * w;
                let ry = (Math.random() - 0.5) * h;
                let dx = Math.abs(rx) / (w/2);
                let dy = Math.abs(ry) / (h/2);
                let dist = Math.max(dx, dy); 
                let threshold = 1 - Math.pow(dist, (intensity/20)); 
                if (Math.random() < threshold) {
                    ctx.beginPath();
                    ctx.arc(cx + rx, cy + ry, 2, 0, Math.PI*2);
                    ctx.fill();
                }
            }
        }

        function applyEdgeScatter(ctx, intensity) {
            const idata = ctx.getImageData(0,0, ctx.canvas.width, ctx.canvas.height);
            const data = idata.data;
            const w = ctx.canvas.width;
            const h = ctx.canvas.height;
            const newCanvas = document.createElement('canvas');
            newCanvas.width = w; newCanvas.height = h;
            const nCtx = newCanvas.getContext('2d');
            nCtx.putImageData(idata, 0, 0);
            
            const scatterCount = intensity * 25; 
            nCtx.fillStyle = "black";
            
            for(let i=0; i<scatterCount; i++) {
                const x = Math.floor(Math.random() * w);
                const y = Math.floor(Math.random() * h);
                const idx = (y * w + x) * 4;
                if (data[idx+3] > 0 && data[idx] < 50) {
                    const angle = Math.random() * Math.PI * 2;
                    const dist = Math.random() * (intensity * 2.5); 
                    nCtx.beginPath();
                    nCtx.arc(x + Math.cos(angle)*dist, y + Math.sin(angle)*dist, 1.5, 0, Math.PI*2);
                    nCtx.fill();
                }
            }
            ctx.drawImage(newCanvas, 0, 0);
        }

        // --- L√ìGICA EXISTENTE ---
        const inputs = document.querySelectorAll('.param-input');
        inputs.forEach(i => i.addEventListener('input', handleParamChange));
        document.getElementById('realWidthCm').addEventListener('input', updateLabels);
        document.getElementById('radius').addEventListener('input', () => { if(isLoadedProject || globalPoints.length > 0) renderSVGPreview(); updateLabels(); });

        function handleParamChange(e) { updateLabels(); }

        function updateLabels() {
            const realW = parseFloat(document.getElementById('realWidthCm').value) || 25;
            const w = canvasWidth > 0 ? canvasWidth : 1000;
            const scaleFactor = (realW * 10) / w; 
            document.getElementById('yStepVal').innerText = (document.getElementById('yStep').value * scaleFactor).toFixed(1);
            document.getElementById('xStepVal').innerText = (document.getElementById('xStep').value * scaleFactor).toFixed(1);
            document.getElementById('angleVal').innerText = document.getElementById('angle').value;
            const rPx = parseFloat(document.getElementById('radius').value);
            document.getElementById('radiusVal').innerText = (rPx * 2 * scaleFactor).toFixed(1);
            if(canvasHeight > 0) {
                const hCm = (canvasHeight * (realW / w)).toFixed(1);
                document.getElementById('dimDisplay').innerText = `Dimensiones Finales: ${realW} cm x ${hCm} cm`;
            }
        }
        window.getLastConfig = () => { return { mode: document.getElementById('mode').value, realWidth: document.getElementById('realWidthCm').value, radiusPx: document.getElementById('radius').value }; }

        window.loadProjectData = (data) => {
            if(confirm("Se reemplazar√° el trabajo actual. ¬øContinuar?")) {
                try {
                    if (data.puntos_json) globalPoints = JSON.parse(data.puntos_json);
                    else alert("Proyecto antiguo no compatible.");
                    document.getElementById('projectName').value = data.nombre_proyecto;
                    isLoadedProject = true;
                    let maxX = 0, maxY = 0;
                    globalPoints.forEach(p => { if(p.x > maxX) maxX = p.x; if(p.y > maxY) maxY = p.y; });
                    canvasWidth = maxX + 50; canvasHeight = maxY + 50;
                    document.getElementById('btnOpenEditor').disabled = false;
                    closeModal('galleryModal');
                    renderSVGPreview(); updateLabels();
                } catch(e) { console.error(e); }
            }
        };

        function processImage() {
            const input = document.getElementById('imageInput');
            const isTextMode = document.getElementById('textToolModal').style.display === 'none' && canvasWidth > 0;
            
            if (!input.files[0] && !isTextMode) return alert("Selecciona imagen o usa el Creador de Texto.");
            
            if (input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const c = document.getElementById('procCanvas');
                        const ctx = c.getContext('2d', { willReadFrequently: true });
                        const maxW = 1000;
                        const scale = maxW / img.width;
                        c.width = maxW; c.height = img.height * scale;
                        canvasWidth = c.width; canvasHeight = c.height;
                        ctx.fillStyle = "white"; ctx.fillRect(0,0,c.width, c.height);
                        ctx.drawImage(img, 0, 0, c.width, c.height);
                        generatePoints(ctx); renderSVGPreview(); updateLabels();
                        document.getElementById('btnOpenEditor').disabled = false;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            } else {
                const c = document.getElementById('procCanvas');
                const ctx = c.getContext('2d');
                generatePoints(ctx); renderSVGPreview();
            }
        }

        function generatePoints(ctx) {
            const yStep = parseInt(document.getElementById('yStep').value);
            const xStep = parseInt(document.getElementById('xStep').value);
            const angle = parseInt(document.getElementById('angle').value) * (Math.PI / 180);
            const mode = document.getElementById('mode').value;
            const w = ctx.canvas.width; const h = ctx.canvas.height;
            const imgData = ctx.getImageData(0, 0, w, h);
            globalPoints = [];

            for (let y = -h; y < h * 2; y += yStep) {
                let segment = [];
                for (let x = -w; x < w * 2; x += 1) {
                    const rotX = Math.floor(x * Math.cos(angle) - y * Math.sin(angle));
                    const rotY = Math.floor(x * Math.sin(angle) + y * Math.cos(angle));
                    if (rotX >= 0 && rotX < w && rotY >= 0 && rotY < h) {
                        const idx = (rotY * w + rotX) * 4;
                        if (imgData.data[idx] < 150) segment.push({x: rotX, y: rotY});
                        else if (segment.length > 0) { addSegment(segment, xStep, mode); segment = []; }
                    }
                }
                if (segment.length > 0) addSegment(segment, xStep, mode);
            }
        }

        function addSegment(seg, step, mode) {
            if (seg.length < 2) return;
            if (mode === 'adaptive') {
                const count = Math.max(1, Math.round(seg.length / step));
                for(let i=0; i<count; i++) {
                    const idx = Math.floor((seg.length / (count+1)) * (i+1));
                    globalPoints.push(seg[idx]);
                }
            } else { for(let i=0; i<seg.length; i+=step) globalPoints.push(seg[i]); }
        }

        function renderSVGPreview() {
            const r = parseFloat(document.getElementById('radius').value);
            let svg = `<svg viewBox="0 0 ${canvasWidth} ${canvasHeight}" style="max-height:100%; max-width:100%;"><g fill="black">`;
            globalPoints.forEach(p => { svg += `<circle cx="${p.x.toFixed(1)}" cy="${p.y.toFixed(1)}" r="${r}" />`; });
            svg += `</g></svg>`;
            document.getElementById('svgContent').innerHTML = svg;
        }

        // --- EDITOR CANVAS ---
        const editorCanvas = document.getElementById('editorCanvas');
        const ctxEdit = editorCanvas.getContext('2d');
        let editTool = 'delete'; let selectedPointIdx = -1; let editorScale = 1; let editorOffsetX = 0; let editorOffsetY = 0; let isDragging = false; let lastMouse = {x:0, y:0};

        function openEditor() {
            backupPoints = JSON.parse(JSON.stringify(globalPoints)); 
            document.getElementById('editorOverlay').style.display = 'flex';
            const rect = document.getElementById('visualWrapper').getBoundingClientRect();
            editorCanvas.width = rect.width; editorCanvas.height = rect.height;
            editorScale = Math.min(editorCanvas.width / canvasWidth, editorCanvas.height / canvasHeight) * 0.9;
            editorOffsetX = (editorCanvas.width - canvasWidth * editorScale) / 2;
            editorOffsetY = (editorCanvas.height - canvasHeight * editorScale) / 2;
            requestAnimationFrame(drawEditorLoop);
        }

        function setTool(t) { editTool = t; selectedPointIdx = -1; document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); document.querySelector(`.tool-btn.${t}`).classList.add('active'); document.getElementById('dpad').style.display = (t === 'move') ? 'grid' : 'none'; drawEditorLoop(); }
        
        function drawEditorLoop() {
            ctxEdit.clearRect(0, 0, editorCanvas.width, editorCanvas.height);
            ctxEdit.save(); ctxEdit.translate(editorOffsetX, editorOffsetY); ctxEdit.scale(editorScale, editorScale);
            ctxEdit.fillStyle = "white"; ctxEdit.fillRect(0,0, canvasWidth, canvasHeight);
            const r = parseFloat(document.getElementById('radius').value);
            for(let i=0; i<globalPoints.length; i++) {
                const p = globalPoints[i];
                ctxEdit.beginPath(); ctxEdit.arc(p.x, p.y, r, 0, Math.PI*2);
                if (editTool === 'delete') { ctxEdit.fillStyle = "black"; ctxEdit.fill(); ctxEdit.lineWidth = r/2; ctxEdit.strokeStyle = "red"; ctxEdit.stroke(); } 
                else if (editTool === 'move' && i === selectedPointIdx) { ctxEdit.fillStyle = "#2196F3"; ctxEdit.fill(); ctxEdit.strokeStyle = "#2196F3"; ctxEdit.lineWidth = 2; ctxEdit.stroke(); }
                else { ctxEdit.fillStyle = "black"; ctxEdit.fill(); }
            }
            ctxEdit.restore();
        }

        function screenToWorld(sx, sy) { return { x: (sx - editorOffsetX) / editorScale, y: (sy - editorOffsetY) / editorScale }; }
        editorCanvas.addEventListener('mousedown', startPan); editorCanvas.addEventListener('mousemove', movePan); editorCanvas.addEventListener('mouseup', endPan);
        editorCanvas.addEventListener('wheel', (e) => {
            e.preventDefault(); const s = (e.deltaY < 0) ? 1.1 : 0.9;
            const rect = editorCanvas.getBoundingClientRect();
            const mx = e.clientX - rect.left; const my = e.clientY - rect.top;
            editorOffsetX = mx - (mx - editorOffsetX) * s; editorOffsetY = my - (my - editorOffsetY) * s;
            editorScale *= s; drawEditorLoop();
        });
        
        editorCanvas.addEventListener('touchstart', (e)=>{ if(e.touches.length === 1) startPan(e.touches[0]); });
        editorCanvas.addEventListener('touchmove', (e)=>{ e.preventDefault(); if(e.touches.length === 1) movePan(e.touches[0]); });
        editorCanvas.addEventListener('touchend', (e)=>{ endPan(e.changedTouches[0]); });

        let startClickTime = 0; let didMove = false;
        function startPan(e) { isDragging = true; didMove = false; startClickTime = Date.now(); const rect = editorCanvas.getBoundingClientRect(); lastMouse = { x: e.clientX - rect.left, y: e.clientY - rect.top }; }
        function movePan(e) { if (!isDragging) return; const rect = editorCanvas.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; if (Math.abs(x - lastMouse.x) > 2 || Math.abs(y - lastMouse.y) > 2) didMove = true; editorOffsetX += (x - lastMouse.x); editorOffsetY += (y - lastMouse.y); lastMouse = {x, y}; drawEditorLoop(); }
        function endPan(e) { isDragging = false; const timeDiff = Date.now() - startClickTime; if (timeDiff < 300 && !didMove) { const rect = editorCanvas.getBoundingClientRect(); handleToolClick((e.clientX || e.pageX) - rect.left, (e.clientY || e.pageY) - rect.top); } }

        function handleToolClick(sx, sy) {
            const wPos = screenToWorld(sx, sy); const r = parseFloat(document.getElementById('radius').value);
            let hitIdx = -1; let minDist = r * 2.5;
            for(let i=0; i<globalPoints.length; i++) { const d = Math.hypot(globalPoints[i].x - wPos.x, globalPoints[i].y - wPos.y); if (d < minDist) { minDist = d; hitIdx = i; } }
            if (editTool === 'delete' && hitIdx !== -1) { globalPoints.splice(hitIdx, 1); manualEditsMade = true; } 
            else if (editTool === 'add' && hitIdx === -1) { globalPoints.push({x: wPos.x, y: wPos.y}); manualEditsMade = true; } 
            else if (editTool === 'move') { if (hitIdx !== -1) selectedPointIdx = hitIdx; else if (selectedPointIdx !== -1) { globalPoints[selectedPointIdx].x = wPos.x; globalPoints[selectedPointIdx].y = wPos.y; manualEditsMade = true; } }
            drawEditorLoop();
        }

        window.nudge = (dx, dy) => { if (selectedPointIdx !== -1) { globalPoints[selectedPointIdx].x += dx; globalPoints[selectedPointIdx].y += dy; manualEditsMade = true; drawEditorLoop(); } };
        window.discardChanges = () => { if(confirm("¬øDescartar?")) { globalPoints = backupPoints; document.getElementById('editorOverlay').style.display = 'none'; manualEditsMade = false; renderSVGPreview(); } };
        window.confirmChanges = () => { if(!document.getElementById('projectName').value.trim()) return alert("Pon nombre al proyecto."); document.getElementById('editorOverlay').style.display = 'none'; renderSVGPreview(); document.getElementById('exportModal').style.display = 'flex'; };

        // --- EXPORTACI√ìN ---
        window.finalizeExport = async (format) => {
            const name = document.getElementById('projectName').value.trim() || "dise√±o";
            const svgString = document.getElementById('svgContent').innerHTML;
            let blob = null; let ext = "";
            if (format === 'svg') { blob = new Blob([svgString], {type: "image/svg+xml"}); ext = ".svg"; } 
            else if (format === 'plt') { blob = new Blob([generatePLT()], {type: "text/plain"}); ext = ".plt"; }
            else if (format === 'ai') { blob = new Blob([generateEPS()], {type: "application/postscript"}); ext = ".ai"; }
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a"); a.href = url; a.download = name + "_JMVN" + ext; a.click();
            if (window.saveToFirebase) await window.saveToFirebase(globalPoints, svgString, format);
            closeModal('exportModal'); alert(`‚úÖ Archivo ${ext} listo.`);
        };

        function generatePLT() {
            const scale = (parseFloat(document.getElementById('realWidthCm').value) * 10 / canvasWidth) * 40;
            const rPlt = (parseFloat(document.getElementById('radius').value) * scale).toFixed(0);
            let plt = "IN;PU;"; 
            globalPoints.forEach(p => { plt += `PU${(p.x * scale).toFixed(0)},${(-p.y * scale).toFixed(0)};CI${rPlt};`; });
            return plt + "PU0,0;IN;";
        }

        function generateEPS() {
            const scale = (parseFloat(document.getElementById('realWidthCm').value) * 28.3465) / canvasWidth;
            const h_pt = canvasHeight * scale; const r = parseFloat(document.getElementById('radius').value) * scale;
            let eps = `%!PS-Adobe-3.0 EPSF-3.0\n%%BoundingBox: 0 0 ${(canvasWidth*scale).toFixed(2)} ${h_pt.toFixed(2)}\n%%Creator: JMVN\n/c { 0 360 arc fill } def\n0 setgray\n`; 
            globalPoints.forEach(p => { eps += `${(p.x * scale).toFixed(2)} ${(h_pt - (p.y * scale)).toFixed(2)} ${r.toFixed(2)} c\n`; });
            return eps + `%%EOF`;
        }
    </script>
</body>
</html>